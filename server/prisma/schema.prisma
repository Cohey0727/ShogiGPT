// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 対局状況
enum MatchStatus {
  ONGOING // 対局中
  COMPLETED // 完了
  ABANDONED // 中断
}

/// プレイヤー
enum Player {
  SENTE // 先手
  GOTE // 後手
}

/// メッセージの送信者ロール
enum MessageRole {
  USER // ユーザー
  ASSISTANT // AI
  SYSTEM // システム
}

/// 対局情報
model Match {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// 対局状況
  status MatchStatus @default(ONGOING)

  /// 先手のプレイヤー名
  playerSente String?

  /// 後手のプレイヤー名
  playerGote String?

  /// この対局の局面履歴
  states MatchState[]

  /// この対局のチャットメッセージ
  messages ChatMessage[]

  @@index([createdAt])
  @@index([status])
  @@map("matches")
}

/// 局面情報（ある時点での盤面状態と、そこに至った指し手）
model MatchState {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  /// 紐づく対局ID
  matchId String
  match   Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)

  /// 局面番号（何手目か、0から開始。0は初期局面）
  index Int

  /// この局面に至った指し手表記（USI形式、例: "7g7f"）
  /// 初期局面（index=0）の場合はnull
  moveNotation String?

  /// この盤面での手番プレイヤー
  player Player

  /// 盤面（SFEN形式）
  sfen String

  /// 消費時間（秒、オプション）
  thinkingTime Int?

  @@index([matchId])
  @@index([matchId, index])
  @@map("match_states")
}

/// チャットメッセージ
model ChatMessage {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  /// 紐づく対局ID
  matchId String
  match   Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)

  /// メッセージの送信者ロール
  role MessageRole

  /// メッセージ本文
  content String

  /// メタデータ（JSON形式、AI推論データなど）
  metadata String?

  @@index([matchId])
  @@index([createdAt])
  @@map("chat_messages")
}
